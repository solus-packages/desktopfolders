From 7e1f593bd6f55de1382201de32470bfcf97174aa Mon Sep 17 00:00:00 2001
From: David Mohammed <fossfreedom@ubuntu.com>
Date: Sun, 24 Feb 2019 18:14:48 +0000
Subject: [PATCH 1/1] Fix compilation issues with vala 0.44

---
 src/Application.vala                  |  6 +++---
 src/settings/PositionSettings.vala    | 11 ++++++++++-
 src/utils/dragndrop/DndBehaviour.vala |  2 +-
 src/utils/dragndrop/DragNDrop.vala    |  4 ++--
 4 files changed, 16 insertions(+), 7 deletions(-)

diff --git a/src/Application.vala b/src/Application.vala
index e521dcc..81ad490 100644
--- a/src/Application.vala
+++ b/src/Application.vala
@@ -437,7 +437,7 @@ public class DesktopFolderApp : Gtk.Application {
                 fm.close ();
                 this.folders.remove (fm);
             }
-            this.folders = updated_folder_list.copy ();
+            this.folders = (owned) updated_folder_list;
 
             // finally we close any other not existent note
             while (this.notes.length () > 0) {
@@ -445,7 +445,7 @@ public class DesktopFolderApp : Gtk.Application {
                 nm.close ();
                 this.notes.remove (nm);
             }
-            this.notes = updated_note_list.copy ();
+            this.notes = (owned) updated_note_list;
 
             // finally we close any other not existent photo
             while (this.photos.length () > 0) {
@@ -453,7 +453,7 @@ public class DesktopFolderApp : Gtk.Application {
                 pm.close ();
                 this.photos.remove (pm);
             }
-            this.photos = updated_photo_list.copy ();
+            this.photos = (owned) updated_photo_list;
 
             // by default, we create at least one folder if set by settings
             if (totalFolders == 0 && totalPhotos == 0 && totalNotes == 0 && this.desktop == null) {
diff --git a/src/settings/PositionSettings.vala b/src/settings/PositionSettings.vala
index 7c3ef36..386a944 100644
--- a/src/settings/PositionSettings.vala
+++ b/src/settings/PositionSettings.vala
@@ -53,7 +53,7 @@ public abstract class DesktopFolder.PositionSettings : Object, Json.Serializable
                 // temporal WEIRD hack to avoid the problem of set an SLIST to the json @value deserializer
                 flag_deserialized = false;
             } else {
-                this._resolutions = value.copy ();
+                this._resolutions = value.copy_deep ((CopyFunc) Object.ref);
             }
             flagChanged = false;
         }
@@ -385,6 +385,15 @@ public abstract class DesktopFolder.PositionSettings : Object, Json.Serializable
         unowned GLib.ParamSpec ? spec = ocl.find_property (name);
         return spec;
     }
+    public GLib.Value Json.Serializable.get_property (GLib.ParamSpec pspec) {
+        GLib.Value result = GLib.Value (pspec.value_type);
+        base.get_property (pspec.name, ref result);
+        return result;
+    }
+
+    public void Json.Serializable.set_property (GLib.ParamSpec pspec, GLib.Value value) {
+        base.set_property (pspec.name, value);
+    }
 
     public Json.Node serialize_property (string property_name, Value @value, ParamSpec pspec) {
         // debug("SERIALIZE -- property_name:%s",property_name);
diff --git a/src/utils/dragndrop/DndBehaviour.vala b/src/utils/dragndrop/DndBehaviour.vala
index 197c5a4..b42539d 100644
--- a/src/utils/dragndrop/DndBehaviour.vala
+++ b/src/utils/dragndrop/DndBehaviour.vala
@@ -162,7 +162,7 @@ namespace DesktopFolder.DragnDrop {
             return selected_files;
         }
 
-        protected unowned GLib.List <File> get_selected_files_for_transfer (GLib.List <unowned File> selection = get_selected_files ()) {
+        protected unowned GLib.List <File> get_selected_files_for_transfer (GLib.List <File> selection = get_selected_files ()) {
             // debug("DndBehaviour-get_selected_files_for_transfer");
             unowned GLib.List <File> list = null;
             list.prepend (this.view.get_file ());
diff --git a/src/utils/dragndrop/DragNDrop.vala b/src/utils/dragndrop/DragNDrop.vala
index ff8182c..e7550d5 100644
--- a/src/utils/dragndrop/DragNDrop.vala
+++ b/src/utils/dragndrop/DragNDrop.vala
@@ -180,11 +180,11 @@ namespace DesktopFolder.DragnDrop {
                             // it is asked only once, and we cannot unset in the future..
                             // So, we allow copy/move/link and after, it is discarded if it was really the same folder.
                             // TODO, need to be further investigated.
-                            GLib.g_object_unref (parent_file);
+                            parent_file.unref ();
                             suggested_action = Gdk.DragAction.COPY; // Gdk.DragAction.ASK;
                             actions          = Gdk.DragAction.COPY | Gdk.DragAction.MOVE | Gdk.DragAction.LINK; // Gdk.DragAction.ASK|Gdk.DragAction.LINK;
                         } else
-                            GLib.g_object_unref (parent_file);
+                            parent_file.unref ();
                     }
 
                     /* Make these tests at the end so that any changes are not reversed subsequently */
-- 
2.21.0

